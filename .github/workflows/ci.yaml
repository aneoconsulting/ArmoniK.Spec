name: Code Integration

on:
  pull_request:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-test-external-modules:
    name: Build and Test External TLA+ Modules
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
    - name: Setup Java
      uses: actions/setup-java@v5
      with:
        java-version: '17'
        distribution: 'temurin'
    - name: Build and test external TLA+ modules with Ant
      run: ant -noinput -buildfile modules/build.xml test

  parse-modules:
    name: Parse TLA+ Modules
    runs-on: ubuntu-latest
    needs: build-test-external-modules
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"
      - name: Install CLI
        run: pip install .
      - name: Install TLA+ tools
        run: tla package install
      - name: Parse specification
        run: cd specs && ls | grep ".tla" | xargs tla parse --external-module ../modules/dist/ArmoniKSpecModules-deps.jar --external-module ../.tla/tools/tlapm/lib/tlapm/stdlib/

  check-models:
    name: Check Models
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"
      - name: Install TLA+ CLI
        run: pip install tla-cli
      - name: Parse specification
        run: tla model-check --manifest manifest.json

  check-proofs:
    name: Check Proofs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"
      - name: Install TLA+ CLI
        run: pip install tla-cli
      - name: Parse specification
        run: tla check-proof --manifest manifest.json
